name: Deploy Next.js App

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      version_tag:
        description: 'Version tag (e.g., v1.2.3) - leave empty for "latest"'
        required: false
        type: string

jobs:
  deploy:
    name: Deploy Next.js Application
    permissions:
      id-token: write
      contents: read
    uses: kustom-1/workflows/.github/workflows/upload-artifact.yaml@main
    with:
      environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'prod' }}
      version_tag: ${{ inputs.version_tag || 'latest' }}
      aws_region: us-east-1
      node_version: '20.x'
      app_name: nextjs-app
      build_command: npm run build
      artifact_path: .next 
      s3_artifact_prefix: frontend
      asg_suffix: presentation-asg
      working_directory: .
      health_check_path: /api/health
      log_path: /var/log/nextjs-app/
      install_command: npm ci
      min_healthy_percentage: 50
      instance_warmup: 300
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}